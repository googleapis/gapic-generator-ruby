<%- assert_locals method -%>
<%- full_client_name = defined?(client_name_full) ? client_name_full : method.service.client_name_full -%>
<%- fields = method.fields_with_first_oneof -%>
def test_<%= method.name %>
  # Create request parameters
  <%- fields.each do |field| -%>
  <%= field.name %> = <%= field.default_value %>
  <%- end -%>

  Gapic::ServiceStub.stub :new, @mock_stub do
    # Create client
    client = <%= full_client_name %>.new do |config|
      config.credentials = @test_channel
    end

    4.times do
      @mock_stub.expect :call_rpc, @response do |name, request, options|
        has_name = name == :<%= method.name %>
        has_options = !options.nil?
        has_fields = <%- fields.each do |field| -%>
          <%- if field.type_name_full.to_s.empty? -%>
          <%= field.default_value %> == request.<%= field.name %> <%= if field != fields.last then "&&" end %>
          <%- else -%>
          Gapic::Protobuf.coerce(<%= field.default_value %>, to: <%= field.type_name_full %>) == request.<%= field.name %> <%= if field != fields.last then "&&" end %>
          <%- end -%>
          <%- end -%>

          puts "invalid method call: #{name} (expected <%= method.name %>)" unless has_name
          puts "invalid options: #{options} vs #{@options}" unless has_options
          puts "invalid fields" unless has_fields

          has_name && has_options && has_fields
      end
    end

    # Call method
    response = client.<%= method.name %> <%= fields.map(&:as_kwarg).join ", " %>
    assert_equal @response, response

    # Call method with options
    response = client.<%= method.name %>({ <%= fields.map(&:as_kwarg).join ", " %> }, @options)
    assert_equal @response, response

    # Call method with block
    client.<%= method.name %> <%= fields.map(&:as_kwarg).join ", " %> do |block_response, operation|
      assert_equal expected_response, block_response
      refute_nil operation
    end

    # Call method with block and options
    client.<%= method.name %>({ <%= fields.map(&:as_kwarg).join ", " %>}, @options) do |block_response, operation|
      assert_equal expected_response, block_response
      refute_nil operation
    end
  end
end
