<%- assert_locals method -%>
extractor = Gapic::RoutingHeaders::HeadersExtractor.new
<%- if method.routing.explicit_params? -%>
<%- method.routing.explicit_params.each do |key_name, routing_infos| -%>
<%- routing_infos.each do |routing_info| -%>
<%- if routing_info.pattern_matching_not_needed? -%>
  .with_bindings(field: "<%= routing_info.field %>", header_name: "<%= key_name %>")
<%- else -%>
  .with_bindings(field: "<%= routing_info.field %>", header_name: "<%= key_name %>", regex: %r{<%= routing_info.field_full_regex_str %>})
<%- end -%>
<%- end -%>
<%- end -%>
<%- else -%>
<%- method.routing_params.each_with_index do |routing_param, index| -%>
  .with_bindings(field: "<%= routing_param %>")
<%- end -%>
<%- end -%>

header_params = extractor.extract_headers request
request_params_header = URI.encode_www_form header_params
metadata[:"x-goog-request-params"] ||= request_params_header
