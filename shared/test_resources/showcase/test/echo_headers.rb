# frozen_string_literal: true

# The MIT License (MIT)
#
# Copyright <YEAR> <COPYRIGHT HOLDER>
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.

# Auto-generated by gapic-generator-ruby. DO NOT EDIT!

require "helper"
require "gapic/rest"
require "google/showcase/v1beta1/echo"
require "google/showcase/v1beta1/echo/rest"


class ::Google::Showcase::V1beta1::Echo::HeadersTest < Minitest::Test
  def setup client=nil
    @client = client
  end

  # Currently cannot be done from the standard test battery in routing.proto:
  # - test_nested_field (no nested field in EchoRequest)
  # - test_overlapping_patterns -- no conflicting overlapping patterns
  # - test_multiple_keyvaluepairs_strict -- requires a very specific pattern setup
  # - test_multiple_conflicts_and_request_fields -- no conflicts
  # - test_complex_scenario -- no conflicts

  # Extracting a field from the request to put into the routing header
  # unchanged, with the key equal to the field name.
  # Extracting a field from the request to put into the routing header
  # unchanged, with the key different from the field name.
  #
  # This tests:
  # - test_simple_extraction
  # - test_rename_extraction
  def test_simple_and_rename_extraction
    test_cases = [
      {
        header_field: "foo.123",
        expected: ["header=foo.123", "routing_id=foo.123"]
      },
      {
        header_field: "projects/100",
        expected: "super_id=projects/100"
      },
    ]

    assert_matches @client, test_cases
  end

  # Extracting a field from the request to put into the routing
  # header, while matching a path template syntax on the field's value.
  # Extracting a single routing header key-value pair by matching a
  # template syntax on (a part of) a single request field.
  #
  # This tests: 
  # - test_field_match
  # - test_simple_extract
  # - test_multiple_keyvaluepairs_loose
  def test_field_match_simple_extract_multiple_kvp
    test_cases = [
      {
        header_field: "projects/100/instances/200",
        expected: ["super_id=projects/100", "table_name=projects/100/instances/200", "instance_id=instances/200"]
      },
      {
        header_field: "regions/100/zones/200",
        expected: ["table_name=regions/100/zones/200",]
      },
      {
        header_field: "projects/100/instances/200/whatever",
        expected: ["super_id=projects/100", "table_name=projects/100/instances/200/whatever", "instance_id=instances/200"]
      },
    ]

    assert_matches @client, test_cases
  end

  # Extracting multiple routing header key-value pairs by matching
  # several path templates on multiple request fields.
  #
  # This tests: 
  # - test_multiple_request_fields
  # - test_complex_scenario (only partially since no conflicts)
  def test_multiple_request_fields_conflicts
    test_cases = [
      {
        header_field: "projects/100",
        other_header_field: "projects/100/misc",
        expected: ["super_id=projects/100", "qux=projects/100", "baz=projects/100/misc"]
      },
      {
        header_field: "projects/100",
        other_header_field: "foo.123",
        expected: ["super_id=projects/100", "baz=foo.123"]
      },
    ]

    assert_matches @client, test_cases
  end

  def assert_matches client, test_cases
    return unless client
    test_cases.each do |test_case|
      request = { content: "foo", header: test_case[:header_field] }
      request[:other_header] = test_case[:other_header_field] if test_case.key? :other_header_field
      @client.echo request do |response, operation|
        routing_keyvals = extract_routing_keyvals operation

        expected = test_case[:expected]
        expected = [expected] unless expected.is_a? ::Array

        refute_nil routing_keyvals
        routing_keys = routing_keyvals.split("&").map { |kvp| kvp.split("=")[0]}
        expected_keys = expected.map {|kvp| kvp.split("=")[0]}

        expected_keys.append("header") unless expected_keys.include? "header"
        expected_keys.append("routing_id") unless expected_keys.include? "routing_id"

        err_str = "Test case keys mismatch:\nRequest: \n#{request.pretty_inspect}\nExpected: \n#{expected.pretty_inspect}" \
        "\nHeaders formed: \n #{routing_keys}"

        assert_equal expected_keys.sort, routing_keys.sort, err_str

        expected.each do |expected_elem|
          expected_elem_encoded = URI.encode_www_form([expected_elem.split("=")])

          err_str = "Test case:\nRequest: \n#{request.pretty_inspect}\nExpected: \n#{expected_elem.pretty_inspect}" \
          "\nEncoded: #{expected_elem_encoded}"
          
          err_str = "#{err_str}\nRouting header formed: \n #{routing_keys}"

          assert_match expected_elem_encoded, routing_keyvals, err_str
        end
      end
    end
  end

  def extract_routing_keyvals operation
  end
end

class ::Google::Showcase::V1beta1::Echo::GrpcHeadersTest < ::Google::Showcase::V1beta1::Echo::HeadersTest
  def setup
    client = Google::Showcase::V1beta1::Echo::Client.new do |config|
      config.credentials = GRPC::Core::Channel.new "localhost:7469", nil, :this_channel_is_insecure
    end

    super client
  end

  def extract_routing_keyvals operation
    assert_kind_of ::Hash, operation.metadata
    assert operation.metadata.key? "x-goog-request-params"
    operation.metadata["x-goog-request-params"]
  end
end

class ::Google::Showcase::V1beta1::Echo::RestHeadersTest < ::Google::Showcase::V1beta1::Echo::HeadersTest
  def setup
    client = Google::Showcase::V1beta1::Echo::Rest::Client.new do |config|
      config.endpoint = "http://localhost:7469"
      config.credentials = :this_channel_is_insecure
    end

    super client
  end

  def extract_routing_keyvals response
    assert_kind_of ::Hash, response.env.request_headers
    assert response.env.request_headers.key? "X-goog-request-params"
    response.env.request_headers["x-goog-request-params"]
  end
end
